# =============================================================================
# HustleX Pro Monorepo CI Pipeline
# =============================================================================
# Continuous Integration for all apps: API, Consumer, Provider, Admin, ML
# Uses path filtering to only build changed components

name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: '1.21'
  FLUTTER_VERSION: '3.16.0'
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  GOLANGCI_LINT_VERSION: 'v1.55'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Detect Changes
  # ===========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.changes.outputs.api }}
      consumer: ${{ steps.changes.outputs.consumer }}
      provider: ${{ steps.changes.outputs.provider }}
      admin: ${{ steps.changes.outputs.admin }}
      ml: ${{ steps.changes.outputs.ml }}
      packages: ${{ steps.changes.outputs.packages }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/go-common/**'
              - 'packages/proto/**'
            consumer:
              - 'apps/consumer-app/**'
              - 'packages/shared-domain/**'
              - 'packages/shared-ui/**'
            provider:
              - 'apps/provider-app/**'
              - 'packages/shared-domain/**'
              - 'packages/shared-ui/**'
            admin:
              - 'apps/admin-web/**'
            ml:
              - 'apps/recommendation/**'
            packages:
              - 'packages/**'

  # ===========================================================================
  # Go API
  # ===========================================================================
  api-lint:
    name: API - Lint
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.api == 'true' }}
    defaults:
      run:
        working-directory: apps/api
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/api/go.sum
      - uses: golangci/golangci-lint-action@v4
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          working-directory: apps/api
          args: --timeout=5m

  api-test:
    name: API - Test
    runs-on: ubuntu-latest
    needs: [changes, api-lint]
    if: ${{ needs.changes.outputs.api == 'true' }}
    defaults:
      run:
        working-directory: apps/api
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: hustlex_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/api/go.sum
      - name: Run tests
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/hustlex_test?sslmode=disable
          REDIS_URL: redis://localhost:6379
        run: go test -v -race -coverprofile=coverage.out ./...
      - uses: codecov/codecov-action@v4
        with:
          files: apps/api/coverage.out
          flags: api

  api-build:
    name: API - Build
    runs-on: ubuntu-latest
    needs: [changes, api-test]
    if: ${{ needs.changes.outputs.api == 'true' }}
    defaults:
      run:
        working-directory: apps/api
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/api/go.sum
      - name: Build
        run: CGO_ENABLED=0 go build -o bin/server cmd/server/main.go
      - uses: actions/upload-artifact@v4
        with:
          name: api-binary
          path: apps/api/bin/server

  # ===========================================================================
  # Flutter Consumer App
  # ===========================================================================
  consumer-app:
    name: Consumer App
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.consumer == 'true' || needs.changes.outputs.packages == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: Install Melos
        run: dart pub global activate melos
      - name: Bootstrap
        run: melos bootstrap
      - name: Generate code
        run: melos run generate
      - name: Analyze
        run: |
          cd apps/consumer-app
          flutter analyze
      - name: Test
        run: |
          cd apps/consumer-app
          flutter test --coverage
      - uses: codecov/codecov-action@v4
        with:
          files: apps/consumer-app/coverage/lcov.info
          flags: consumer-app
      - name: Build APK
        run: |
          cd apps/consumer-app
          flutter build apk --release
      - uses: actions/upload-artifact@v4
        with:
          name: consumer-app-apk
          path: apps/consumer-app/build/app/outputs/flutter-apk/app-release.apk

  # ===========================================================================
  # Flutter Provider App
  # ===========================================================================
  provider-app:
    name: Provider App
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.provider == 'true' || needs.changes.outputs.packages == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: Install Melos
        run: dart pub global activate melos
      - name: Bootstrap
        run: melos bootstrap
      - name: Analyze
        run: |
          cd apps/provider-app
          flutter analyze || true
      - name: Test
        run: |
          cd apps/provider-app
          flutter test || true

  # ===========================================================================
  # Admin Web Dashboard
  # ===========================================================================
  admin-web:
    name: Admin Dashboard
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.admin == 'true' }}
    defaults:
      run:
        working-directory: apps/admin-web
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install & Build
        run: |
          npm ci 2>/dev/null || npm install || true
          npm run lint || true
          npm run build || true

  # ===========================================================================
  # ML Recommendation Service
  # ===========================================================================
  recommendation:
    name: ML Service
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.ml == 'true' }}
    defaults:
      run:
        working-directory: apps/recommendation
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install & Test
        run: |
          pip install -r requirements.txt 2>/dev/null || true
          pip install pytest flake8 || true
          flake8 . --count --select=E9,F63,F7,F82 --show-source || true
          pytest || true

  # ===========================================================================
  # Docker Images
  # ===========================================================================
  docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [api-build, consumer-app]
    if: github.ref == 'refs/heads/main' && always()
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build API Image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          push: true
          tags: ghcr.io/${{ github.repository }}/api:${{ github.sha }},ghcr.io/${{ github.repository }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
        continue-on-error: true
