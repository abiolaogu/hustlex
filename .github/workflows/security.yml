# =============================================================================
# HustleX Security Workflow
# =============================================================================
# Comprehensive security scanning running daily and on-demand
# Includes: SAST, dependency audit, secret scanning, container scanning

name: Security Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_scan:
        description: 'Run full security scan including slow checks'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - '**/go.mod'
      - '**/go.sum'
      - '**/Dockerfile'

env:
  GO_VERSION: '1.22'

jobs:
  # ===========================================================================
  # Dependency Audit
  # ===========================================================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > vulncheck-results.json || true
          govulncheck ./...

      - name: Check for outdated dependencies
        run: |
          go list -u -m -json all | go run -mod=mod github.com/psampaz/go-mod-outdated@latest -update -direct

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-report
          path: backend/vulncheck-results.json
          retention-days: 30

  # ===========================================================================
  # Static Application Security Testing (SAST)
  # ===========================================================================
  sast:
    name: SAST Analysis
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    permissions:
      security-events: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-fmt sarif -out gosec-results.sarif -severity medium -confidence medium ./...'
          working-directory: backend

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: backend/gosec-results.sarif

      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/golang
            p/owasp-top-ten
            p/security-audit
          generateSarif: true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  # ===========================================================================
  # Secret Scanning
  # ===========================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_NOTIFY_USER_LIST: '@security-team'

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --json

  # ===========================================================================
  # Container Security
  # ===========================================================================
  container-scan:
    name: Container Security
    runs-on: ubuntu-latest
    needs: sast

    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile
          push: false
          load: true
          tags: hustlex-api:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'hustlex-api:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Dockle linter
        uses: erzz/dockle-action@v1
        with:
          image: 'hustlex-api:scan'
          failure-threshold: high
          exit-code: 1

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: backend/Dockerfile
          failure-threshold: warning

  # ===========================================================================
  # Infrastructure as Code Security
  # ===========================================================================
  iac-scan:
    name: IaC Security
    runs-on: ubuntu-latest
    if: github.event.inputs.full_scan == 'true' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: infrastructure/
          framework: kubernetes,dockerfile
          output_format: sarif
          output_file_path: checkov-results.sarif
          skip_check: CKV_K8S_21,CKV_K8S_22  # Skip namespace and read-only checks if needed

      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif

      - name: Run Kubesec
        run: |
          curl -sSX POST --data-binary @infrastructure/k8s/base/deployment.yaml https://v2.kubesec.io/scan || true

  # ===========================================================================
  # License Compliance
  # ===========================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    if: github.event.inputs.full_scan == 'true' || github.event_name == 'schedule'
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Check licenses
        run: |
          go install github.com/google/go-licenses@latest
          go-licenses check ./... --disallowed_types=restricted,reciprocal || true

      - name: Generate license report
        run: |
          go-licenses csv ./... > licenses.csv || true

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: backend/licenses.csv
          retention-days: 90

  # ===========================================================================
  # Security Report
  # ===========================================================================
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [dependency-audit, sast, secret-scan, container-scan]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Generate summary report
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST Analysis | ${{ needs.sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Security | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          fields: repo,workflow,job,commit,author
          text: ':warning: Security scan found issues! Please review immediately.'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
